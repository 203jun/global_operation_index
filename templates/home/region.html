{% extends "layouts/base.html" %}

{% block title %} Region {% endblock %}

{% block content %}
<div class="pcoded-main-container">
    <div class="pcoded-content">
        <!-- [ Main Content ] start -->
        <div class="page-header">
            <div class="page-block">
                <div class="row align-items-center">
                    <div class="col-md-12">
                        <div class="page-header-title">
                            <h2 class="m-b-10">Region Dashboard</h2>
                        </div>
                        <ul class="breadcrumb">
                            <li class="breadcrumb-item"><a href="/"><i class="feather icon-home"></i></a></li>
                            <li class="breadcrumb-item"><a href="#!">Region</a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
        <!-- [ Main Content ] end -->

        <!-- [ Main Content ] start -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5>Region Overview</h5>
                        <span>지역별 운영 현황을 확인할 수 있습니다.</span>
                        <div class="float-end">
                            <div class="dropdown">
                                <button class="btn btn-sm btn-outline-primary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                    {{ current_month }}월
                                </button>
                                <ul class="dropdown-menu">
                                    <li><a class="dropdown-item month-change" href="#" data-month="1">1월</a></li>
                                    <li><a class="dropdown-item month-change" href="#" data-month="2">2월</a></li>
                                    <li><a class="dropdown-item month-change" href="#" data-month="3">3월</a></li>
                                    <li><a class="dropdown-item month-change" href="#" data-month="4">4월</a></li>
                                    <li><a class="dropdown-item month-change" href="#" data-month="5">5월</a></li>
                                    <li><a class="dropdown-item month-change" href="#" data-month="6">6월</a></li>
                                    <li><a class="dropdown-item month-change" href="#" data-month="7">7월</a></li>
                                    <li><a class="dropdown-item month-change" href="#" data-month="8">8월</a></li>
                                    <li><a class="dropdown-item month-change" href="#" data-month="9">9월</a></li>
                                    <li><a class="dropdown-item month-change" href="#" data-month="10">10월</a></li>
                                    <li><a class="dropdown-item month-change" href="#" data-month="11">11월</a></li>
                                    <li><a class="dropdown-item month-change" href="#" data-month="12">12월</a></li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        {% if has_data %}
                        <div class="text-center py-5">
                            <i class="feather icon-map f-40 text-primary"></i>
                            <h4 class="mt-3 text-primary">Region Dashboard</h4>
                            <p class="text-muted">지역별 운영 지표가 여기에 표시됩니다.</p>
                            {% if selected_region %}
                            <div class="mt-4">
                                <small class="text-muted">
                                    <strong>선택된 지역:</strong> {{ selected_region }}<br>
                                    <strong>기준월:</strong> {{ current_month }}월
                                </small>
                            </div>

                            <!-- Region Logic 데이터 표시 -->
                            <div id="regionSummary" class="mt-4">
                                <h6>Region Logic Data:</h6>
                                <div id="summaryContent">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                    데이터를 불러오는 중...
                                </div>
                            </div>
                            {% else %}
                            <div class="mt-4">
                                <small class="text-muted">
                                    <strong>기준월:</strong> {{ current_month }}월
                                </small>
                            </div>
                            {% endif %}
                        </div>
                        {% else %}
                        <div class="text-center py-5">
                            <i class="feather icon-alert-circle f-40 text-warning"></i>
                            <h4 class="mt-3 text-warning">데이터 없음</h4>
                            <p class="text-muted">{{ current_month }}월 데이터가 존재하지 않습니다.</p>
                            <div class="mt-4">
                                <small class="text-muted">
                                    {% if selected_region %}
                                    <strong>선택된 지역:</strong> {{ selected_region }}<br>
                                    {% endif %}
                                    <strong>기준월:</strong> {{ current_month }}월<br>
                                    <strong>상태:</strong> <span class="text-warning">데이터 없음</span>
                                </small>
                            </div>
                            <div class="mt-3">
                                <button class="btn btn-sm btn-outline-primary" onclick="location.reload()">
                                    <i class="feather icon-refresh-cw"></i> 새로고침
                                </button>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        <!-- [ Main Content ] end -->
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // 기준월 변경 이벤트 리스너
    const monthChangeLinks = document.querySelectorAll('.month-change');

    monthChangeLinks.forEach(link => {
        link.addEventListener('click', function(e) {
            e.preventDefault();

            const selectedMonth = this.getAttribute('data-month');
            const currentUrl = new URL(window.location.href);

            // URL의 month 파라미터 업데이트
            currentUrl.searchParams.set('month', selectedMonth);

            // 페이지 이동
            window.location.href = currentUrl.toString();
        });
    });

    // Region 요약 데이터 로딩
    loadRegionSummary();
});

// Region Logic 데이터 로딩
function loadRegionSummary() {
    const urlParams = new URLSearchParams(window.location.search);
    const month = urlParams.get('month') || {{ current_month }};
    const region = '{{ selected_region }}';

    if (!region || region === 'None') {
        const content = document.getElementById('summaryContent');
        if (content) {
            content.innerHTML = '<p class="text-muted">지역이 선택되지 않았습니다.</p>';
        }
        return;
    }

    console.log('지역 Logic 데이터 로딩 시작:', { region, month });

    fetch(`/api/region-logic-data/${encodeURIComponent(region)}/${month}`)
        .then(response => {
            console.log('지역 Logic 응답 상태:', response.status);
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('지역 Logic 응답 데이터:', data);
            if (data.success) {
                displayRegionLogicData(data);
            } else {
                showRegionSummaryError(data.error || '지역 Logic 데이터를 불러올 수 없습니다.');
            }
        })
        .catch(error => {
            console.error('지역 Logic 로딩 오류:', error);
            showRegionSummaryError(`네트워크 오류가 발생했습니다: ${error.message}`);
        });
}

// Region Logic 데이터 표시
function displayRegionLogicData(data) {
    const content = document.getElementById('summaryContent');
    if (!content) return;

    if (Object.keys(data.data).length === 0) {
        content.innerHTML = '<p class="text-muted">데이터가 없습니다.</p>';
        return;
    }

    let html = '<div class="table-responsive"><table class="table table-striped">';
    html += '<thead><tr><th>지표명</th><th>값</th></tr></thead><tbody>';

    // 데이터를 카테고리별로 정렬하여 표시
    const categories = {
        '기본 통계': ['Planned_Courses', 'Completed_Courses', 'Planned_Hours', 'Actual_Hours'],
        '신입사원': ['New_Hire_Total', 'New_Hire_Completed', 'New_Hire_Not_Completed', 'New_Hire_Pending'],
        '핵심인재(EIP)': ['EIP_Total', 'EIP_Completed', 'EIP_Not_Completed'],
        '핵심인재(GLP)': ['GLP_Total', 'GLP_Completed', 'GLP_Not_Completed'],
        '완료율': ['Course_Completion_Rate', 'Hours_Completion_Rate', 'New_Hire_Completion_Rate', 'EIP_Completion_Rate', 'GLP_Completion_Rate']
    };

    for (const [category, fields] of Object.entries(categories)) {
        html += `<tr><td colspan="2" class="table-active"><strong>${category}</strong></td></tr>`;

        for (const field of fields) {
            if (data.data[field] !== undefined) {
                let value = data.data[field];
                let unit = '';

                // 완료율 필드는 % 표시
                if (field.includes('Rate')) {
                    unit = '%';
                }
                // 시간 관련 필드는 시간 표시
                else if (field.includes('Hours')) {
                    unit = '시간';
                }
                // 숫자 필드는 천 단위 콤마 표시
                else if (typeof value === 'number') {
                    value = value.toLocaleString();
                }

                html += `<tr><td>${field}</td><td><strong>${value}${unit}</strong></td></tr>`;
            }
        }
    }

    html += '</tbody></table></div>';
    html += `<p class="text-muted mt-2">지역: <strong>${data.region}</strong>, 기준월: <strong>${data.month}월</strong></p>`;

    content.innerHTML = html;
}

// Region 요약 오류 표시
function showRegionSummaryError(message) {
    const content = document.getElementById('summaryContent');
    if (!content) return;

    content.innerHTML = `
        <div class="alert alert-danger">
            <i class="feather icon-alert-circle me-2"></i>
            ${message}
        </div>
    `;
}
</script>
{% endblock content %}
